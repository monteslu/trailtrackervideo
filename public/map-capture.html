<!DOCTYPE html>
<html>
<head>
    <title>Map Capture</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="map-container">
        <div id="routeMap" class="leaflet-map"></div>
        <div id="detailMap" class="leaflet-map"></div>
    </div>
    
    <div class="coordinates-display">
        <p>Lat: <span id="latDisplay">--</span> | Lon: <span id="lonDisplay">--</span></p>
        <p>Raw: <span id="rawCompassDisplay">--</span>Â° | Bearing: <span id="bearingDisplay">--</span>Â° | <span id="cardinalDisplay">--</span></p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize maps when parent tells us to
        window.initializeMaps = function() {
            window.routeMap = L.map('routeMap', { zoomControl: false }).setView([33.4484, -112.0740], 10);
            window.detailMap = L.map('detailMap', { zoomControl: false }).setView([33.4484, -112.0740], 17);
            
            L.tileLayer('/api/tiles/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(window.routeMap);
            
            L.tileLayer('/api/tiles/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(window.detailMap);
            
            // Set up event listeners for when maps are ready
            window.setupMapReadyEvents();
            
            // Set initial coordinates display
            document.getElementById('latDisplay').textContent = '33.448400';
            document.getElementById('lonDisplay').textContent = '-112.074000';
            document.getElementById('rawCompassDisplay').textContent = '0';
            document.getElementById('bearingDisplay').textContent = '90';
            document.getElementById('cardinalDisplay').textContent = 'E';
            
            // Send map div coordinates back to parent (with delay to ensure elements are fully rendered)
            setTimeout(() => {
                window.sendMapCoordinates();
                
                // Notify parent that popup is ready for data
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'popupReady'
                    }, '*');
                    console.log('âœ… Notified parent that popup is ready');
                }
            }, 200);
            
            return { routeMap: window.routeMap, detailMap: window.detailMap };
        };
        
        // Auto-initialize maps when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOM loaded, initializing maps...');
            // Small delay to ensure Leaflet is loaded
            setTimeout(() => {
                window.initializeMaps();
            }, 100);
        });
        
        // Set up event listeners to detect when maps are ready
        window.setupMapReadyEvents = function() {
            let detailMapReady = false;
            let routeMapReady = false;
            
            // Listen for when detail map finishes moving/loading
            window.detailMap.on('moveend', function() {
                detailMapReady = true;
                window.checkBothMapsReady('detailMoveEnd');
            });
            
            window.detailMap.on('load', function() {
                detailMapReady = true;
                window.checkBothMapsReady('detailLoad');
            });
            
            // Listen for when route map finishes moving/loading  
            window.routeMap.on('moveend', function() {
                routeMapReady = true;
                window.checkBothMapsReady('routeMoveEnd');
            });
            
            window.routeMap.on('load', function() {
                routeMapReady = true;
                window.checkBothMapsReady('routeLoad');
            });
            
            // Reset flags when we start a new update
            window.resetMapReadyFlags = function() {
                detailMapReady = false;
                routeMapReady = false;
            };
            
            window.checkBothMapsReady = function(eventType) {
                if (detailMapReady && routeMapReady) {
                    console.log(`ğŸ“¸ Both maps ready after ${eventType}`);
                    updateSequenceStarted = false; // Reset for next update
                    window.notifyMapReady(eventType);
                }
            };
        };
        
        // Function to calculate and send map div coordinates to parent
        window.sendMapCoordinates = function() {
            try {
                const routeMapDiv = document.getElementById('routeMap');
                const detailMapDiv = document.getElementById('detailMap');
                
                if (routeMapDiv && detailMapDiv) {
                    // Get bounding rectangles relative to the viewport/window
                    const routeBounds = routeMapDiv.getBoundingClientRect();
                    const detailBounds = detailMapDiv.getBoundingClientRect();
                    
                    const mapCoordinates = {
                        routeMap: {
                            left: Math.round(routeBounds.left),
                            top: Math.round(routeBounds.top), 
                            width: Math.round(routeBounds.width),
                            height: Math.round(routeBounds.height),
                            right: Math.round(routeBounds.right),
                            bottom: Math.round(routeBounds.bottom)
                        },
                        detailMap: {
                            left: Math.round(detailBounds.left),
                            top: Math.round(detailBounds.top),
                            width: Math.round(detailBounds.width), 
                            height: Math.round(detailBounds.height),
                            right: Math.round(detailBounds.right),
                            bottom: Math.round(detailBounds.bottom)
                        }
                    };
                    
                    console.log('ğŸ“ Map div coordinates:');
                    console.log('  routeMap:', mapCoordinates.routeMap);
                    console.log('  detailMap:', mapCoordinates.detailMap);
                    console.log('ğŸ“ Window.opener exists:', !!window.opener);
                    
                    // Send coordinates to opener window (popup uses opener, not parent)
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'mapCoordinates',
                            coordinates: mapCoordinates
                        }, '*');
                        console.log('ğŸ“ Coordinates sent to opener window');
                    } else {
                        console.warn('No opener window found to send coordinates to');
                    }
                } else {
                    console.warn('Could not find routeMap or detailMap divs');
                }
            } catch (error) {
                console.warn('Could not send map coordinates:', error);
            }
        };
        
        // Debug function - can be called from console
        window.debugSendCoordinates = function() {
            console.log('Manual coordinate send triggered');
            window.sendMapCoordinates();
        };
        
        // Notify parent window that maps are ready for screenshot
        window.notifyMapReady = function(updateType) {
            try {
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'mapReady',
                        updateType: updateType,
                        timestamp: Date.now()
                    }, '*');
                    console.log(`ğŸ“¸ Notified parent: maps ready for screenshot after ${updateType}`);
                } else {
                    console.warn('No opener window found to notify map ready');
                }
            } catch (error) {
                console.warn('Could not notify map ready:', error);
            }
        };
        
        // Track if we're in the middle of an update sequence
        let updateSequenceStarted = false;
        
        // Track current direction to prevent flickering
        let currentDirection = 'east'; // 'east' or 'west'
        
        // Function to determine direction with north/south deadband
        window.updateDirection = function(bearing) {
            let newDirection = currentDirection;
            
            console.log(`ğŸ§­ Direction logic: bearing=${bearing}Â°, current=${currentDirection}`);
            
            // North deadband: 355Â° to 5Â° - don't change direction
            if (bearing >= 355 || bearing <= 5) {
                console.log(`ğŸ§­ North deadband (${bearing}Â°), keeping current direction: ${currentDirection}`);
                return currentDirection === 'west';
            }
            
            // South deadband: 175Â° to 185Â° - don't change direction  
            if (bearing >= 175 && bearing <= 185) {
                console.log(`ğŸ§­ South deadband (${bearing}Â°), keeping current direction: ${currentDirection}`);
                return currentDirection === 'west';
            }
            
            // Clear east/west zones
            if (bearing > 5 && bearing < 175) {
                // Eastern quadrant
                if (currentDirection === 'west') {
                    newDirection = 'east';
                    console.log(`ğŸ”„ Switching from west to east (${bearing}Â°)`);
                }
            } else if (bearing > 185 && bearing < 355) {
                // Western quadrant  
                if (currentDirection === 'east') {
                    newDirection = 'west';
                    console.log(`ğŸ”„ Switching from east to west (${bearing}Â°)`);
                }
            }
            
            if (newDirection === currentDirection) {
                console.log(`â†”ï¸ Keeping current direction: ${currentDirection}`);
            }
            
            currentDirection = newDirection;
            console.log(`ğŸ¯ Final direction: ${currentDirection}, isWest: ${currentDirection === 'west'}`);
            return currentDirection === 'west';
        };

        // Function to get cardinal direction from bearing
        window.getCardinalDirection = function(bearing) {
            if (bearing >= 337.5 || bearing < 22.5) return 'N';
            if (bearing >= 22.5 && bearing < 67.5) return 'NE';
            if (bearing >= 67.5 && bearing < 112.5) return 'E';
            if (bearing >= 112.5 && bearing < 157.5) return 'SE';
            if (bearing >= 157.5 && bearing < 202.5) return 'S';
            if (bearing >= 202.5 && bearing < 247.5) return 'SW';
            if (bearing >= 247.5 && bearing < 292.5) return 'W';
            if (bearing >= 292.5 && bearing < 337.5) return 'NW';
            return '--';
        };

        // Listen for messages from parent window
        window.addEventListener('message', function(event) {
            console.log('ğŸ”„ Popup received message:', event.data);
            const { type, routeCoords, lat, lon, bearing, rawCompass } = event.data;
            
            // Debug what we're receiving
            if (bearing !== undefined) {
                console.log(`ğŸ“ˆ Bearing data: ${bearing}Â°, raw: ${rawCompass || 'null'}, source: ${event.data.bearingSource || 'unknown'}`);
            }
            
            // Debug bearing specifically
            if (bearing !== undefined) {
                console.log(`ğŸ“ Popup received bearing: ${bearing}Â°`);
            }
            
            // Calculate direction once if bearing is provided
            let isGoingWest = false;
            if (bearing !== undefined && bearing !== null) {
                isGoingWest = window.updateDirection(bearing);
                console.log(`Bearing: ${bearing}Â°, Direction: ${currentDirection}, Flipped: ${isGoingWest}`);
            }
            
            switch(type) {
                case 'updateRoute':
                    console.log('Updating route with', routeCoords.length, 'points');
                    if (window.routePolyline) window.routeMap.removeLayer(window.routePolyline);
                    window.routePolyline = L.polyline(routeCoords, { color: '#e74c3c', weight: 3 }).addTo(window.routeMap);
                    
                    const bounds = L.latLngBounds(routeCoords);
                    window.routeMap.fitBounds(bounds, { padding: [10, 10] });
                    console.log('Route updated, bounds:', bounds.toBBoxString());
                    break;
                    
                case 'updateDetailPosition':
                    console.log('Updating detail position to:', lat, lon);
                    
                    // Reset ready flags at the start of update sequence
                    if (!updateSequenceStarted) {
                        updateSequenceStarted = true;
                        window.resetMapReadyFlags();
                        console.log('ğŸ”„ Started map update sequence');
                    }
                    
                    window.detailMap.setView([lat, lon], 17);
                    if (window.detailMarker) window.detailMap.removeLayer(window.detailMarker);
                    
                    
                    const bikeIcon = L.icon({
                        iconUrl: isGoingWest ? '/images/luis_bike_100_west.png' : '/images/luis_bike_100_east.png',
                        iconSize: [50, 50],
                        iconAnchor: [25, 50]
                    });
                    
                    window.detailMarker = L.marker([lat, lon], { icon: bikeIcon }).addTo(window.detailMap);
                    console.log('Detail position updated, waiting for moveend events...');
                    
                    // Update coordinate display
                    document.getElementById('latDisplay').textContent = lat.toFixed(6);
                    document.getElementById('lonDisplay').textContent = lon.toFixed(6);
                    document.getElementById('rawCompassDisplay').textContent = rawCompass !== null && rawCompass !== undefined ? rawCompass.toFixed(1) : '--';
                    document.getElementById('bearingDisplay').textContent = bearing !== null && bearing !== undefined ? bearing.toFixed(1) : '--';
                    document.getElementById('cardinalDisplay').textContent = bearing !== null && bearing !== undefined ? window.getCardinalDirection(bearing) : '--';
                    break;
                    
                case 'updateRouteMarker':
                    console.log('Updating route marker to:', lat, lon);
                    if (window.routeMarker) window.routeMap.removeLayer(window.routeMarker);
                    
                    
                    const routeBikeIcon = L.icon({
                        iconUrl: isGoingWest ? '/images/luis_bike_100_west.png' : '/images/luis_bike_100_east.png',
                        iconSize: [35, 35],
                        iconAnchor: [17, 35]
                    });
                    
                    window.routeMarker = L.marker([lat, lon], { icon: routeBikeIcon }).addTo(window.routeMap);
                    console.log('Route marker updated');
                    
                    // Update coordinate display
                    document.getElementById('latDisplay').textContent = lat.toFixed(6);
                    document.getElementById('lonDisplay').textContent = lon.toFixed(6);
                    document.getElementById('rawCompassDisplay').textContent = rawCompass !== null && rawCompass !== undefined ? rawCompass.toFixed(1) : '--';
                    document.getElementById('bearingDisplay').textContent = bearing !== null && bearing !== undefined ? bearing.toFixed(1) : '--';
                    document.getElementById('cardinalDisplay').textContent = bearing !== null && bearing !== undefined ? window.getCardinalDirection(bearing) : '--';
                    break;
            }
        });
    </script>
</body>
</html>